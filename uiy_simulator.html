<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <link rel="stylesheet" href="styleguide.css" />
    <link rel="stylesheet" href="style_uiy_simulator.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <main class="ipad-pro-uiy">
      <div class="top">
        <header class="header">
          <a href="index.html" aria-label="ClubEarth í™ˆìœ¼ë¡œ ì´ë™">
            <img
              class="logo"
              src="https://c.animaapp.com/acujdZT9/img/logo-1.svg"
              alt="ClubEarth"
            />
          </a>
          <a href="mypage.html"
            ><p class="p">
              <span class="span">ë°˜ê°€ì›Œìš”, </span>
              <span class="text-wrapper-4">ë¶€ì›</span>
              <span class="span">ë‹˜</span>
            </p></a
          >

          <nav class="buttons" aria-label="ì£¼ìš” ë©”ë‰´">
            <a href="mypage.html"
              ><button class="button-mypage" aria-label="ë§ˆì´í˜ì´ì§€">
                <span class="img-wrapper"
                  ><img
                    class="union"
                    src="https://c.animaapp.com/acujdZT9/img/union-3.svg"
                    alt=""
                /></span></button
            ></a>
            <a href="community.html"
              ><button class="button-community" aria-label="ì»¤ë®¤ë‹ˆí‹°">
                <img
                  class="img-wrapper"
                  src="https://c.animaapp.com/acujdZT9/img/icon-communityoff-2.svg"
                  alt=""
                /></button
            ></a>
            <a href="uiy_select.html"
              ><button
                class="button-uiy"
                aria-label="ì œì‘í•˜ê¸°"
                aria-current="page"
              >
                <span class="img-wrapper">
                  <img class="exclude" src="img/icon_uiy.png" alt="" />
                </span></button
            ></a>
          </nav>
        </header>
      </div>
    </main>

    <!-- ---top end--- -->

    <h1 id="selection-heading" class="text-wrapper-3">
      ì–´ë–¤ ê²ƒì„ ì œì‘í•´ ë³¼ê¹Œìš”?
    </h1>
    <nav class="steps" aria-label="ì§„í–‰ ë‹¨ê³„">
      <img src="img/steps_02.png" alt="4ë‹¨ê³„ ì¤‘ 2ë‹¨ê³„" />
    </nav>

    <div id="image-editor">
      <div class="editor-title">
        <p>íŒ¨í„´ì´ ì˜ ë³´ì´ë„ë¡ ì˜ë¼ì£¼ì„¸ìš”!</p>
        <button id="back"><img src="img/icon_close.png" /></button>
      </div>
      <div class="image-container">
        <img id="image" />
      </div>

      <div class="buttons">
        <button id="rotate"><img src="img/icon_rotate.png" /></button>
        <button id="done">ì ìš©</button>
      </div>
    </div>

    <div id="webcam">
      <div class="webcam-title">
        <p>íŒ¨í„´ì´ ì˜ ë³´ì´ë„ë¡ ì´¬ì˜í•´ ì£¼ì„¸ìš”</p>
        <button id="back"><img src="img/icon_close.png" /></button>
      </div>
      <div class="camera-container">
        <video id="cameraview" width="720" height="480"></video>
      </div>

      <div class="buttons">
        <button id="capture"></button>
      </div>
    </div>

    <div class="info">
      <div class="info_con">
        <img src="img/info_01.jpg" />
      </div>
      <div class="label">Iinformation</div>
    </div>
    <div id="customize">
      <div class="label">customize</div>
      <div class="con-customize">
        <ul>
          <div class="title">ìƒ‰ìƒ</div>
          <li class="color-picker-wrapper">
            <input type="color" id="color_picker" />
          </li>
          <li class="color-black" style="background-color: #222"></li>
          <li class="color-white" style="background-color: #fff"></li>
          <li class="color-red" style="background-color: #ff6868"></li>
          <li class="color-orange" style="background-color: #ffb74b"></li>
          <li class="color-lemon" style="background-color: #fffd87"></li>
          <li class="color-green" style="background-color: #76d97c"></li>
          <li class="color-blue" style="background-color: #6aa3ff"></li>
          <li class="color-purple" style="background-color: #c68cf9"></li>
        </ul>
        <ul>
          <div class="title">íŒ¨í„´</div>
          <li
            class="texture-denim"
            style="background-image: url(img/texture-bg-01.jpg)"
          ></li>
          <li
            class="texture-wool"
            style="background-image: url(img/texture-bg-02.jpg)"
          ></li>
          <li
            class="texture-cotton"
            style="background-image: url(img/texture-bg-03.jpg)"
          ></li>
        </ul>
        <ul>
          <div class="title">íŒ¨í„´ ì§ì ‘ ì ìš©</div>
          <li class="upload-wrapper">
            <input type="file" id="image_upload" accept="image/*" />
          </li>
          <li
            class="camera"
            style="background-image: url(img/texture-bg-05.jpg)"
          ></li>
        </ul>
      </div>
    </div>

    <div class="bottom_buttons">
      <a href="uiy_select.html">
        <button class="back">
          <img src="img/icon_more.png" />
          <p>BACK</p>
        </button></a
      >
      <a href="uiy_guide.html">
        <button class="button-done">
          <p>ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ</p>
          <img
            src="https://c.animaapp.com/acujdZT9/img/frame-357.svg"
            alt=""
          /></button
      ></a>
      <a href="uiy_guide.html">
        <button class="skip">
          <p>SKIP</p>
          <img src="img/icon_more.png" /></button
      ></a>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-entity
        camera
        position="0 1.6 -2"
        look-controls="enabled: false"
      ></a-entity>

      <a-gltf-model
        id="model"
        src=""
        position="0 0.8 -10"
        scale="0.7 0.7 0.7"
      ></a-gltf-model>
    </a-scene>
  </body>

  <!-- ----------------------------------------------------------------- -->
  <script>
    let model = document.querySelector('#model')
    let imageUpload = document.querySelector('#image_upload')
    let image = document.querySelector('#image')
    let imageEditor = document.querySelector('#image-editor')
    let doneButton = document.querySelector('#done')
    let rotateButton = document.querySelector('#rotate')
    let cropper // ìƒ‰ìƒ ì„ íƒ

    let colorPicker = document.querySelector('#color_picker')
    colorPicker.addEventListener('input', function (e) {
      let selectedColor = e.target.value
      let part = model.object3D.getObjectByName('uiy')
      if (part) {
        part.material.map = null
        part.material.color.set(selectedColor)
      }
    })
    colorPicker.addEventListener('click', function (e) {
      e.stopPropagation()
    })

    // ìƒ‰ìƒ ì ìš©
    document.querySelectorAll('.con-customize li').forEach((li) => {
      li.addEventListener('click', () => {
        let bgColor = window.getComputedStyle(li).backgroundColor
        if (window.getComputedStyle(li).backgroundImage !== 'none') return
        let part = model.object3D.getObjectByName('uiy')
        if (part) {
          part.material.map = null
          part.material.color.set(bgColor)
        }
      })
    })

    // í…ìŠ¤ì²˜ ì ìš©
    function applyTexture(imgPath) {
      let texture = new THREE.TextureLoader().load(imgPath, function () {
        let part = model.object3D.getObjectByName('uiy')
        if (part) {
          texture.wrapS = THREE.RepeatWrapping
          texture.wrapT = THREE.RepeatWrapping
          texture.flipY = false
          part.material.map = texture
          part.material.map.needsUpdate = true
        }
      })
    }

    // ê°ê° í…ìŠ¤ì²˜ ë²„íŠ¼ì— ì ìš©
    document.querySelector('.texture-denim').addEventListener('click', () => {
      applyTexture('img/texture-01.jpg')
    })
    document.querySelector('.texture-wool').addEventListener('click', () => {
      applyTexture('img/texture-02.jpg')
    })
    document.querySelector('.texture-cotton').addEventListener('click', () => {
      applyTexture('img/texture-03.jpg')
    })

    // ì´ë¯¸ì§€ ì—ë””í„° í‘œì‹œ (íŒŒì¼ ì—…ë¡œë“œ)
    imageUpload.addEventListener('change', function (e) {
      let file = e.target.files[0]
      let reader = new FileReader()
      reader.onload = function (evt) {
        image.src = evt.target.result
        if (cropper) cropper.destroy()
        cropper = new Cropper(image, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 0.8,
        })
        imageEditor.classList.add('is-visible')
        rotateButton.style.display = 'block'
        doneButton.style.display = 'block'
      }
      reader.readAsDataURL(file)
    })

    // íšŒì „ ë²„íŠ¼
    rotateButton.addEventListener('click', function () {
      if (cropper) {
        cropper.rotate(90)
      }
    })

    // í¬ë¡­ ì ìš© ë²„íŠ¼
    doneButton.addEventListener('click', function () {
      if (cropper) {
        let croppedCanvas = cropper.getCroppedCanvas()
        croppedCanvas.toBlob(function (blob) {
          let texture = new THREE.TextureLoader().load(
            URL.createObjectURL(blob),
            function () {
              let part = model.object3D.getObjectByName('uiy')
              if (part) {
                texture.wrapS = THREE.RepeatWrapping
                texture.wrapT = THREE.RepeatWrapping
                texture.flipY = false
                if (part) {
                  part.material.map = texture
                  part.material.map.needsUpdate = true
                }
              }
            }
          )
        })
      }
      imageEditor.classList.remove('is-visible')
    })

    // ì—ë””í„° ë‹«ê¸° (X ë²„íŠ¼)
    let backButton = document.querySelector('#image-editor #back')
    backButton.addEventListener('click', function () {
      imageEditor.classList.remove('is-visible')
    })

    // A-Frame ëª¨ë¸ ë“œë˜ê·¸ íšŒì „
    document.addEventListener('DOMContentLoaded', () => {
      // --- ğŸ‘‡ [ìˆ˜ì •] ëª¨ë¸ë³„ ìŠ¤ì¼€ì¼ ë° í¬ì§€ì…˜ ê´€ë¦¬ ë¡œì§ ---
      try {
        const urlParams = new URLSearchParams(window.location.search)
        const modelFile = urlParams.get('model')

        // 1. ëª¨ë¸ë³„ ìŠ¤ì¼€ì¼ ê°’ì„ ë¯¸ë¦¬ ì •ì˜
        const modelScales = {
          'cardcase.glb': '0.7 0.7 0.7',
          'stringbag.glb': '0.45 0.45 0.45',
          'minibag.glb': '0.3 0.3 0.3',
        }

        // 2. ê¸°ë³¸ê°’ ì„¤ì •
        let srcToLoad = 'cardcase.glb'
        let scaleToLoad = modelScales[srcToLoad]

        // 3. [ì¶”ê°€] í¬ì§€ì…˜ ê¸°ë³¸ê°’ ì„¤ì • (HTMLì˜ ê¸°ë³¸ê°’ê³¼ ë™ì¼)
        let positionToLoad = '0 1 -10'

        // 4. URLì— ë§ëŠ” ëª¨ë¸ê³¼ ìŠ¤ì¼€ì¼ ê°’ ì°¾ê¸°
        if (modelFile && modelScales[modelFile]) {
          srcToLoad = modelFile
          scaleToLoad = modelScales[modelFile]

          // 5. [ì¶”ê°€] ì˜ˆì™¸(minibag)ì¸ì§€ í™•ì¸
          if (modelFile === 'minibag.glb') {
            positionToLoad = '0 -.2 -10'
          }
        }

        // 6. ëª¨ë¸(src), ìŠ¤ì¼€ì¼(scale), í¬ì§€ì…˜(position)ì„ ë™ì‹œ ì ìš©
        model.setAttribute('src', srcToLoad)
        model.setAttribute('scale', scaleToLoad)
        model.setAttribute('position', positionToLoad) // ğŸ‘ˆ í¬ì§€ì…˜ ì ìš©
      } catch (e) {
        console.error('ëª¨ë¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', e)
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ëª¨ë¸ ë¡œë“œ
        model.setAttribute('src', 'cardcase.glb')
        model.setAttribute('scale', '0.7 0.7 0.7')
        model.setAttribute('position', '0 1 -10')
      }
      // --- [ìˆ˜ì •] ë ---

      let sceneEl = document.querySelector('a-scene')
      sceneEl.style.zIndex = '1'
      sceneEl.addEventListener('loaded', () => {
        let canvas = sceneEl.canvas
        if (!canvas) {
          console.warn('A-Frame canvas not found.')
          return
        }
        canvas.style.touchAction = 'none'
        let isDragging = false
        let lastX = 0
        let lastY = 0
        let rotation = { x: 0, y: 0 }
        let SENSITIVITY = 1
        function startDrag(clientX, clientY) {
          isDragging = true
          lastX = clientX
          lastY = clientY
        }
        function moveDrag(clientX, clientY) {
          if (!isDragging) return
          let dx = clientX - lastX
          let dy = clientY - lastY
          rotation.y += dx * SENSITIVITY
          rotation.x += dy * SENSITIVITY
          rotation.x = Math.max(Math.min(rotation.x, 80), -80)

          if (model) {
            model.setAttribute('rotation', `${-rotation.x} ${rotation.y} 0`)
          }
          lastX = clientX
          lastY = clientY
        }
        function endDrag() {
          isDragging = false
        }
        canvas.addEventListener('mousedown', (e) =>
          startDrag(e.clientX, e.clientY)
        )
        window.addEventListener('mousemove', (e) =>
          moveDrag(e.clientX, e.clientY)
        )
        window.addEventListener('mouseup', endDrag)
        canvas.addEventListener('touchstart', (e) => {
          if (e.touches.length === 1) {
            startDrag(e.touches[0].clientX, e.touches[0].clientY)
          }
        })
        canvas.addEventListener('touchmove', (e) => {
          if (e.touches.length === 1) {
            moveDrag(e.touches[0].clientX, e.touches[0].clientY)
          }
        })
        canvas.addEventListener('touchend', endDrag)
        canvas.addEventListener('touchcancel', endDrag)
      })
    })

    // -------ì¹´ë©”ë¼ -------

    // 1. í•„ìš”í•œ ë³€ìˆ˜ë“¤ì„ ëª¨ë‘ ì„ ì–¸í•©ë‹ˆë‹¤.
    let cameraButton = document.querySelector('.camera')
    let webcamPopup = document.querySelector('#webcam')
    let backButtons = document.querySelectorAll('#webcam #back')
    let cameraView = document.querySelector('#cameraview')
    let shutterButton = document.querySelector('#capture')
    let canvas = document.createElement('canvas')
    let stream

    // 2. íŒì—… ì—´ê¸° + ì¹´ë©”ë¼ ì‹œì‘
    cameraButton.addEventListener('click', async () => {
      webcamPopup.classList.add('is-visible')
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true })
        cameraView.srcObject = stream
        await cameraView.play()
      } catch (err) {
        alert('ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
        console.error(err)
      }
    })

    // 3. íŒì—… ë‹«ê¸° ë²„íŠ¼ (ì›¹ìº  íŒì—…ìš©)
    backButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        webcamPopup.classList.remove('is-visible')
        stopCamera()
      })
    })

    // 4. ì¹´ë©”ë¼ ì •ì§€ í•¨ìˆ˜
    function stopCamera() {
      if (stream) {
        let tracks = stream.getTracks()
        tracks.forEach((t) => t.stop())
        stream = null
      }
      cameraView.srcObject = null
    }

    // 5. ğŸ“¸ ì´¬ì˜ ë²„íŠ¼ í´ë¦­ ì‹œ
    shutterButton.addEventListener('click', () => {
      if (!stream) return
      let video = cameraView
      let width = video.videoWidth
      let height = video.videoHeight
      canvas.width = width
      canvas.height = height
      let ctx = canvas.getContext('2d')
      ctx.translate(width, 0)
      ctx.scale(-1, 1)
      ctx.drawImage(video, 0, 0, width, height)
      ctx.setTransform(1, 0, 0, 1, 0, 0)
      let imageDataUrl = canvas.toDataURL('image/png')
      webcamPopup.classList.remove('is-visible')
      stopCamera()

      // Cropper í™”ë©´ì— ì´ë¯¸ì§€ ì ìš©
      image.src = imageDataUrl
      if (cropper) cropper.destroy()
      cropper = new Cropper(image, {
        aspectRatio: 1,
        viewMode: 1,
        autoCropArea: 0.8,
      })

      imageEditor.classList.add('is-visible')
    })
  </script>
</html>
